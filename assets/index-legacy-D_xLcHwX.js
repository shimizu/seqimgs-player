System.register([],function(e,t){"use strict";return{execute:function(){var e=document.createElement("style");e.textContent=":root{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;background-color:#f6f8fa;color:#1f2328}body{margin:0;min-height:100vh}.demo{margin:0 auto;padding:24px 16px 40px;display:flex;flex-direction:column;gap:24px}.demo__header h1{margin:0 0 8px;font-size:1.8rem;line-height:1.2}.demo__lead{margin:0;line-height:1.6;font-size:.95rem}.demo__controls{display:flex;flex-direction:column;align-items:stretch;gap:10px}.demo__layout{display:flex;flex-direction:column;gap:24px}.demo__controls button{padding:12px 18px;border-radius:8px;border:1px solid #c3d0e0;background:#fff;color:inherit;font-size:1rem;transition:background-color .2s ease}.demo__controls button:hover:not(:disabled){background-color:#e9eff7}.demo__controls button:disabled{cursor:wait;opacity:.6}.demo__player{display:flex;justify-content:center}.demo__viewport{--viewport-aspect: 9 / 16;width:100%;max-width:720px;background:#111;border-radius:16px;border:1px solid #202020;overflow:hidden;display:grid;place-items:center;aspect-ratio:var(--viewport-aspect)}.demo__viewport[data-variant=desktop]{--viewport-aspect: 16 / 9}.demo__viewport[data-variant=mobile]{--viewport-aspect: 9 / 16}.demo__viewport canvas,.demo__viewport img{width:100%;height:100%;object-fit:contain;background:#111}.demo__notes ul{margin:0;padding-left:18px;line-height:1.6}.demo__notes li+li{margin-top:6px}.demo__footer{font-size:.9rem;color:#4a5568}@media (min-width: 600px){.demo{padding:32px 24px 56px;gap:28px}.demo__header h1{font-size:2.1rem}.demo__lead{font-size:1rem}.demo__controls{flex-direction:row;flex-wrap:wrap;gap:12px}.demo__controls button{flex:0 1 auto;min-width:140px}.demo__viewport{max-width:960px}.demo__viewport[data-variant=mobile]{max-width:720px;--viewport-aspect: 9 / 16}}@media (min-width: 960px){.demo{max-width:1080px;padding:48px 32px 72px;gap:32px}.demo__layout{display:grid;grid-template-columns:360px 1fr;gap:32px;align-items:start}.demo__controls{flex-direction:row;align-items:center}.demo__viewport{border-radius:20px}}\n/*$vite$:1*/",document.head.appendChild(e);const t={extension:"webp",interval:100,loop:!0,publicPath:"/imgs/",autoPlay:!0,renderTarget:"canvas",fps:void 0,responsiveSwitching:!1};class i{constructor(e){if(this.options=this.#e(e),this.#t(this.options),this.mountEl=document.getElementById(this.options.mountId),!this.mountEl)throw new Error(`mountId="${this.options.mountId}" の要素が見つかりません。`);this.canvasEl=null,this.ctx=null,this.imageEl=null,this.mountEl.innerHTML="","canvas"===this.options.renderTarget?(this.canvasEl=document.createElement("canvas"),this.canvasEl.style.willChange="transform, opacity",this.canvasEl.style.display="block",this.canvasEl.style.width="100%",this.canvasEl.style.height="auto",this.mountEl.appendChild(this.canvasEl),this.ctx=this.canvasEl.getContext("2d",{alpha:!1})):(this.imageEl=document.createElement("img"),this.imageEl.decoding="async",this.imageEl.loading="eager",this.imageEl.style.display="block",this.imageEl.style.willChange="opacity",this.mountEl.appendChild(this.imageEl)),this.currentIndex=0,this.isPlaying=!1,this.isReady=!1,this.timerId=null,this.preloadPromise=null,this.preloadedFrames=[],this._frameInterval=1e3/(this.options.fps||1e3/this.options.interval),this._accumulator=0,this._lastTs=0,this._rafId=null,this.options.autoPlay&&this.preload().then(()=>this.play()).catch(e=>{console.error("自動再生に失敗しました:",e)})}async preload(){if(!this.isReady){if(!this.preloadPromise){const e="function"==typeof createImageBitmap;this.preloadPromise=Promise.all(this.options.imageNames.map(t=>this.#i(t,e)))}try{this.preloadedFrames=await this.preloadPromise,this.isReady=!0;const e=this.preloadedFrames[0];if(e){const{width:t,height:i}=await this.#a(e);if(this.canvasEl){const e=Math.max(1,Math.min(2,window.devicePixelRatio||1));this.canvasEl.width=Math.round(t*e),this.canvasEl.height=Math.round(i*e),this.canvasEl.style.aspectRatio=`${t} / ${i}`,this.ctx&&this.ctx.setTransform(e,0,0,e,0,0)}this.#n(0)}}catch(e){throw this.preloadPromise=null,e}}}async play(){if(this.isPlaying)return;if(await this.#r(),this.preloadPromise&&await this.preloadPromise,!this.preloadedFrames.length)return void console.warn("再生可能なフレームが見つかりません。");this.isPlaying=!0,this._lastTs=performance.now();const e=t=>{if(!this.isPlaying)return;const i=t-this._lastTs;for(this._lastTs=t,this._accumulator+=i;this._accumulator>=this._frameInterval;)this._accumulator-=this._frameInterval,this.#o();this._rafId=requestAnimationFrame(e)};this.#n(this.currentIndex),this._rafId=requestAnimationFrame(e)}pause(){this.isPlaying&&(this.isPlaying=!1,null!=this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),null!==this.timerId&&(clearInterval(this.timerId),this.timerId=null))}stop(){this.pause(),this.currentIndex=0,this.isReady&&this.preloadedFrames.length?this.#n(0):(this.imageEl&&this.imageEl.removeAttribute("src"),this.ctx&&this.canvasEl&&this.ctx.clearRect(0,0,this.canvasEl.width,this.canvasEl.height))}setSpeed(e){!Number.isFinite(e)||e<=0?console.warn("setSpeed: 正の数値を指定してください。"):(this.options.interval=e,this.options.fps=void 0,this._frameInterval=e)}setFps(e){!Number.isFinite(e)||e<=0?console.warn("setFps: 正の数値を指定してください。"):(this.options.fps=e,this._frameInterval=1e3/e)}setLoop(e){this.options.loop=Boolean(e)}dispose(){this.stop(),this.mountEl.innerHTML="";for(const e of this.preloadedFrames)if("close"in e&&"function"==typeof e.close)try{e.close()}catch{}this.preloadedFrames=[],this.preloadPromise=null,this.isReady=!1,this.canvasEl=null,this.ctx=null,this.imageEl=null}destroy(){this.dispose()}async#r(){this.isReady||await this.preload()}#o(){if(!this.preloadedFrames.length)return;let e=this.currentIndex+1;if(e>=this.preloadedFrames.length){if(!this.options.loop)return void this.pause();e=0}this.currentIndex=e,this.#n(this.currentIndex)}#n(e){const t=this.preloadedFrames[e];if(t)if(this.currentIndex=e,this.ctx&&this.canvasEl){const{width:e,height:i}=this.canvasEl;this.ctx.clearRect(0,0,e,i),ImageBitmap,this.ctx.drawImage(t,0,0,e,i)}else this.imageEl&&(t instanceof ImageBitmap?console.warn('renderTarget: "img" では ImageBitmap を直接表示できません。canvas を使用してください。'):this.imageEl.src=t.src)}async#i(e,t){const i=this.#s(e);try{const e=await fetch(i,{cache:"force-cache",credentials:"same-origin"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const a=await e.blob();if(t)return await createImageBitmap(a);{const e=URL.createObjectURL(a),t=new Image;t.decoding="async";const n=()=>{try{URL.revokeObjectURL(e)}catch{}};try{return await new Promise((a,n)=>{t.onload=a,t.onerror=()=>n(new Error(`画像の読み込みに失敗: ${i}`)),t.src=e}),"function"==typeof t.decode&&await t.decode(),t}finally{t.src=i,n()}}}catch(a){return await this.#l(i)}}#l(e){return new Promise((t,i)=>{const a=new Image;a.decoding="async",a.onload=async()=>{try{"function"==typeof a.decode&&await a.decode()}catch(e){console.warn("decode に失敗しましたが処理を継続します:",e)}t(a)},a.onerror=()=>i(new Error(`画像の読み込みに失敗しました: ${e}`)),a.src=e})}async#a(e){return e instanceof ImageBitmap?{width:e.width,height:e.height}:{width:e.naturalWidth,height:e.naturalHeight}}#s(e){return`${this.options.publicPath}${e}.${this.options.extension}`}#e(e){const i={...t,...e||{}};return i.publicPath=this.#c(i.publicPath),null!=i.fps&&Number.isFinite(Number(i.fps))&&Number(i.fps)>0?(i.fps=Number(i.fps),i.interval=1e3/i.fps):i.interval=this.#d(i.interval),"canvas"!==i.renderTarget&&"img"!==i.renderTarget&&(i.renderTarget=t.renderTarget),i}#t(e){if(!e.mountId)throw new Error("mountId を指定してください。");if(!Array.isArray(e.imageNames)||0===e.imageNames.length)throw new Error("imageNames には1件以上のファイル名を指定してください。");if(!e.extension)throw new Error("extension を指定してください。")}#c(e){return"string"!=typeof e||0===e.length?t.publicPath:e.endsWith("/")?e:`${e}/`}#d(e){const i=Number(e);return!Number.isFinite(i)||i<=0?t.interval:i}}const a=Array.from({length:101},(e,t)=>`takasaki_${String(t).padStart(4,"0")}`),n={mountId:"player",extension:"webp",interval:80,loop:!0,autoPlay:!1,responsiveSwitching:!0},r=function({variants:e,playerOptions:t,breakpointQuery:a,breakpointWidth:n,debounceMs:r}){const o=e??{},s=Object.keys(o),l=s;if(0===s.length)throw new Error("最小1種類の画像セットを指定してください。");const c=Object.prototype.hasOwnProperty.call(o,"desktop"),d=Object.prototype.hasOwnProperty.call(o,"mobile"),h=c?"desktop":s[0],p=a,m=Number.isFinite(n)?Number(n):900,u=Number.isFinite(r)?Number(r):150;let g=null,y=null,f=Boolean(t?.responsiveSwitching),v=null,w=null,x=!1,b=Promise.resolve();const _=new Set,E="undefined"!=typeof window;E&&"function"==typeof window.matchMedia&&(v=window.matchMedia(p));const I=e=>e&&d?"mobile":!e&&c?"desktop":h,P=()=>{if(!E)return h;if(v)return I(v.matches);const e=window.innerWidth||0;return I(e<=m)},F=async(e,{preserveState:a}={})=>{if(!e)return{player:g,variantKey:y};if(e===y&&g)return{player:g,variantKey:y};const n=o[e];if(!n)return console.warn(`未定義のvariant "${e}" が指定されました。`),{player:g,variantKey:y};const r=g,s=Boolean(a),l=s&&!0===r?.isPlaying,c=s&&!0===r?.isReady;if(r)try{r.destroy()}catch(p){console.warn("既存プレイヤーの破棄に失敗しました:",p)}const d=new i({...t,...n});if(g=d,y=e,c)try{await d.preload()}catch(p){console.error("プリロードの再実行に失敗しました:",p)}l&&d.play().catch(e=>{console.error("切り替え後の再生再開に失敗しました:",e)});const h={player:d,variantKey:e};return(e=>{for(const t of _)try{t(e)}catch(p){console.error("variant listener の呼び出しに失敗しました:",p)}})(h),h},k=(e,t={})=>(b=b.catch(()=>{}).then(()=>F(e,t)),b=b.catch(e=>(console.error("画像バリアントの切り替えに失敗しました:",e),{player:g,variantKey:y})),b),L=(e={})=>{E&&f&&(window.clearTimeout(w),w=window.setTimeout(()=>{const t=P();t&&t!==y&&k(t,e)},u))},T=()=>L({preserveState:!0}),C=()=>L({preserveState:!0}),S=()=>{E&&!x&&(x=!0,v&&("function"==typeof v.addEventListener?v.addEventListener("change",T):"function"==typeof v.addListener&&v.addListener(T)),window.addEventListener("resize",C))};E&&(b=F(P(),{preserveState:!1}).catch(e=>(console.error("初期バリアントの設定に失敗しました:",e),{player:g,variantKey:y})),f&&S());const N=(e,t={})=>o[e]?k(e,t):(console.warn(`forceVariant: 未定義のvariant "${e}" が指定されました。`),Promise.resolve({player:g,variantKey:y}));return{getPlayer:()=>g,getVariant:()=>y,getVariants:()=>[...l],onVariantChange:e=>"function"!=typeof e?()=>{}:(_.add(e),y&&e({player:g,variantKey:y}),()=>{_.delete(e)}),setResponsiveSwitching(e){const t=Boolean(e);t!==f&&(f=t,f?(S(),L({preserveState:!0})):E&&x&&(x=!1,window.clearTimeout(w),v&&("function"==typeof v.removeEventListener?v.removeEventListener("change",T):"function"==typeof v.removeListener&&v.removeListener(T)),window.removeEventListener("resize",C)))},forceVariant:N,cycleVariant:()=>{if(!l.length)return Promise.resolve({player:g,variantKey:y});const e=l.indexOf(y),t=e>=0?(e+1)%l.length:0,i=l[t];return N(i,{preserveState:!0})}}}({variants:{desktop:{imageNames:a,publicPath:"./imgs/desktop/"},mobile:{imageNames:a,publicPath:"./imgs/mobile/"}},playerOptions:n,breakpointQuery:"(max-width: 900px)",breakpointWidth:900,debounceMs:150}),o=document.getElementById(n.mountId)?.closest(".demo__viewport"),s=document.getElementById("resize-button");function l(e,t){const i=document.getElementById(e);i instanceof HTMLButtonElement?t(i):console.warn(`${e} ボタンが見つかりませんでした。`)}r.onVariantChange(({variantKey:e})=>{o&&o.setAttribute("data-variant",e||""),s&&(s.dataset.variant=e||"",s.textContent=e?`サイズ変更 (${e})`:"サイズ変更")}),l("preload-button",e=>{e.addEventListener("click",async()=>{const t=r.getPlayer();if(!t)return void console.warn("プレイヤーが初期化されていません。");e.disabled=!0;const i=e.textContent??"プリロード";e.textContent="プリロード中...";try{await t.preload(),e.textContent="プリロード完了"}catch(a){console.error("プリロードに失敗しました:",a),e.textContent="プリロード失敗"}finally{setTimeout(()=>{e.textContent=i,e.disabled=!1},600)}})}),l("play-button",e=>{e.addEventListener("click",async()=>{const t=r.getPlayer();if(!t)return void console.warn("プレイヤーが初期化されていません。");e.disabled=!0;const i=e.textContent??"再生";e.textContent="再生準備中...";try{await t.play(),e.textContent="再生中"}catch(a){console.error("再生に失敗しました:",a),e.textContent="再生失敗"}finally{setTimeout(()=>{e.textContent=i,e.disabled=!1},400)}})}),l("pause-button",e=>{e.addEventListener("click",()=>{const e=r.getPlayer();e?e.pause():console.warn("プレイヤーが初期化されていません。")})}),l("stop-button",e=>{e.addEventListener("click",()=>{const e=r.getPlayer();e?e.stop():console.warn("プレイヤーが初期化されていません。")})}),l("resize-button",e=>{e.addEventListener("click",async()=>{try{await r.cycleVariant()}catch(e){console.error("サイズ変更に失敗しました:",e)}})})}}});
