System.register([],function(e,t){"use strict";return{execute:function(){var e=document.createElement("style");e.textContent=":root{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;background-color:#f6f8fa;color:#1f2328}body{margin:0;min-height:100vh}.demo{max-width:960px;margin:0 auto;padding:48px 24px 64px;display:flex;flex-direction:column;gap:32px}.demo__header h1{margin:0 0 8px;font-size:2.2rem}.demo__lead{margin:0;line-height:1.6}.demo__controls{display:flex;flex-wrap:wrap;gap:12px}.demo__controls button{padding:10px 18px;border-radius:6px;border:1px solid #c3d0e0;background:#fff;color:inherit;font-size:1rem}.demo__controls button:hover:not(:disabled){background-color:#e9eff7}.demo__controls button:disabled{cursor:wait;opacity:.6}.demo__player{display:flex;justify-content:center}.demo__viewport{width:min(100%,520px);aspect-ratio:4/3;background:#111;border-radius:12px;border:1px solid #202020;overflow:hidden;display:grid;place-items:center}.demo__viewport img{width:100%;height:100%;object-fit:contain;background:#111}.demo__notes ul{margin:0;padding-left:20px;line-height:1.6}.demo__notes li+li{margin-top:6px}.demo__footer{font-size:.9rem;color:#4a5568}\n/*$vite$:1*/",document.head.appendChild(e);const t={extension:"webp",interval:100,loop:!0,publicPath:"/imgs/",autoPlay:!0,renderTarget:"canvas",fps:void 0,responsiveSwitching:!1};class i{constructor(e){if(this.options=this.#e(e),this.#t(this.options),this.mountEl=document.getElementById(this.options.mountId),!this.mountEl)throw new Error(`mountId="${this.options.mountId}" の要素が見つかりません。`);this.canvasEl=null,this.ctx=null,this.imageEl=null,this.mountEl.innerHTML="","canvas"===this.options.renderTarget?(this.canvasEl=document.createElement("canvas"),this.canvasEl.style.willChange="transform, opacity",this.canvasEl.style.display="block",this.canvasEl.style.width="100%",this.canvasEl.style.height="auto",this.mountEl.appendChild(this.canvasEl),this.ctx=this.canvasEl.getContext("2d",{alpha:!1})):(this.imageEl=document.createElement("img"),this.imageEl.decoding="async",this.imageEl.loading="eager",this.imageEl.style.display="block",this.imageEl.style.willChange="opacity",this.mountEl.appendChild(this.imageEl)),this.currentIndex=0,this.isPlaying=!1,this.isReady=!1,this.timerId=null,this.preloadPromise=null,this.preloadedFrames=[],this._frameInterval=1e3/(this.options.fps||1e3/this.options.interval),this._accumulator=0,this._lastTs=0,this._rafId=null,this.options.autoPlay&&this.preload().then(()=>this.play()).catch(e=>{console.error("自動再生に失敗しました:",e)})}async preload(){if(!this.isReady){if(!this.preloadPromise){const e="function"==typeof createImageBitmap;this.preloadPromise=Promise.all(this.options.imageNames.map(t=>this.#i(t,e)))}try{this.preloadedFrames=await this.preloadPromise,this.isReady=!0;const e=this.preloadedFrames[0];if(e){const{width:t,height:i}=await this.#n(e);if(this.canvasEl){const e=Math.max(1,Math.min(2,window.devicePixelRatio||1));this.canvasEl.width=Math.round(t*e),this.canvasEl.height=Math.round(i*e),this.canvasEl.style.aspectRatio=`${t} / ${i}`,this.ctx&&this.ctx.setTransform(e,0,0,e,0,0)}this.#s(0)}}catch(e){throw this.preloadPromise=null,e}}}async play(){if(this.isPlaying)return;if(await this.#a(),this.preloadPromise&&await this.preloadPromise,!this.preloadedFrames.length)return void console.warn("再生可能なフレームが見つかりません。");this.isPlaying=!0,this._lastTs=performance.now();const e=t=>{if(!this.isPlaying)return;const i=t-this._lastTs;for(this._lastTs=t,this._accumulator+=i;this._accumulator>=this._frameInterval;)this._accumulator-=this._frameInterval,this.#r();this._rafId=requestAnimationFrame(e)};this.#s(this.currentIndex),this._rafId=requestAnimationFrame(e)}pause(){this.isPlaying&&(this.isPlaying=!1,null!=this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),null!==this.timerId&&(clearInterval(this.timerId),this.timerId=null))}stop(){this.pause(),this.currentIndex=0,this.isReady&&this.preloadedFrames.length?this.#s(0):(this.imageEl&&this.imageEl.removeAttribute("src"),this.ctx&&this.canvasEl&&this.ctx.clearRect(0,0,this.canvasEl.width,this.canvasEl.height))}setSpeed(e){!Number.isFinite(e)||e<=0?console.warn("setSpeed: 正の数値を指定してください。"):(this.options.interval=e,this.options.fps=void 0,this._frameInterval=e)}setFps(e){!Number.isFinite(e)||e<=0?console.warn("setFps: 正の数値を指定してください。"):(this.options.fps=e,this._frameInterval=1e3/e)}setLoop(e){this.options.loop=Boolean(e)}dispose(){this.stop(),this.mountEl.innerHTML="";for(const e of this.preloadedFrames)if("close"in e&&"function"==typeof e.close)try{e.close()}catch{}this.preloadedFrames=[],this.preloadPromise=null,this.isReady=!1,this.canvasEl=null,this.ctx=null,this.imageEl=null}destroy(){this.dispose()}async#a(){this.isReady||await this.preload()}#r(){if(!this.preloadedFrames.length)return;let e=this.currentIndex+1;if(e>=this.preloadedFrames.length){if(!this.options.loop)return void this.pause();e=0}this.currentIndex=e,this.#s(this.currentIndex)}#s(e){const t=this.preloadedFrames[e];if(t)if(this.currentIndex=e,this.ctx&&this.canvasEl){const{width:e,height:i}=this.canvasEl;this.ctx.clearRect(0,0,e,i),ImageBitmap,this.ctx.drawImage(t,0,0,e,i)}else this.imageEl&&(t instanceof ImageBitmap?console.warn('renderTarget: "img" では ImageBitmap を直接表示できません。canvas を使用してください。'):this.imageEl.src=t.src)}async#i(e,t){const i=this.#o(e);try{const e=await fetch(i,{cache:"force-cache",credentials:"same-origin"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const n=await e.blob();if(t)return await createImageBitmap(n);{const e=URL.createObjectURL(n),t=new Image;t.decoding="async";const s=()=>{try{URL.revokeObjectURL(e)}catch{}};try{return await new Promise((n,s)=>{t.onload=n,t.onerror=()=>s(new Error(`画像の読み込みに失敗: ${i}`)),t.src=e}),"function"==typeof t.decode&&await t.decode(),t}finally{t.src=i,s()}}}catch(n){return await this.#l(i)}}#l(e){return new Promise((t,i)=>{const n=new Image;n.decoding="async",n.onload=async()=>{try{"function"==typeof n.decode&&await n.decode()}catch(e){console.warn("decode に失敗しましたが処理を継続します:",e)}t(n)},n.onerror=()=>i(new Error(`画像の読み込みに失敗しました: ${e}`)),n.src=e})}async#n(e){return e instanceof ImageBitmap?{width:e.width,height:e.height}:{width:e.naturalWidth,height:e.naturalHeight}}#o(e){return`${this.options.publicPath}${e}.${this.options.extension}`}#e(e){const i={...t,...e||{}};return i.publicPath=this.#c(i.publicPath),null!=i.fps&&Number.isFinite(Number(i.fps))&&Number(i.fps)>0?(i.fps=Number(i.fps),i.interval=1e3/i.fps):i.interval=this.#h(i.interval),"canvas"!==i.renderTarget&&"img"!==i.renderTarget&&(i.renderTarget=t.renderTarget),i}#t(e){if(!e.mountId)throw new Error("mountId を指定してください。");if(!Array.isArray(e.imageNames)||0===e.imageNames.length)throw new Error("imageNames には1件以上のファイル名を指定してください。");if(!e.extension)throw new Error("extension を指定してください。")}#c(e){return"string"!=typeof e||0===e.length?t.publicPath:e.endsWith("/")?e:`${e}/`}#h(e){const i=Number(e);return!Number.isFinite(i)||i<=0?t.interval:i}}const n=Array.from({length:101},(e,t)=>`takasaki_${String(t).padStart(4,"0")}`),s=function({variants:e,playerOptions:t,breakpointQuery:n,breakpointWidth:s,debounceMs:a}){const r=e??{},o=Object.keys(r);if(0===o.length)throw new Error("最小1種類の画像セットを指定してください。");const l=Object.prototype.hasOwnProperty.call(r,"desktop"),c=Object.prototype.hasOwnProperty.call(r,"mobile"),h=l?"desktop":o[0],d=n,m=Number.isFinite(s)?Number(s):900,p=Number.isFinite(a)?Number(a):150;let u=null,g=null,f=Boolean(t?.responsiveSwitching),y=null,w=null,v=!1,b=Promise.resolve();const x="undefined"!=typeof window;x&&"function"==typeof window.matchMedia&&(y=window.matchMedia(d));const E=e=>e&&c?"mobile":!e&&l?"desktop":h,I=()=>{if(!x)return h;if(y)return E(y.matches);const e=window.innerWidth||0;return E(e<=m)},_=async(e,{preserveState:n}={})=>{if(!e)return u;if(e===g&&u)return u;const s=r[e];if(!s)return console.warn(`未定義のvariant "${e}" が指定されました。`),u;const a=u,o=Boolean(n),l=o&&!0===a?.isPlaying,c=o&&!0===a?.isReady;if(a)try{a.destroy()}catch(d){console.warn("既存プレイヤーの破棄に失敗しました:",d)}const h=new i({...t,...s});if(u=h,g=e,c)try{await h.preload()}catch(d){console.error("プリロードの再実行に失敗しました:",d)}return l&&h.play().catch(e=>{console.error("切り替え後の再生再開に失敗しました:",e)}),h},P=(e={})=>{x&&f&&(window.clearTimeout(w),w=window.setTimeout(()=>{const t=I();t&&t!==g&&((e,t={})=>{b=b.catch(()=>{}).then(()=>_(e,t)).catch(e=>{console.error("画像バリアントの切り替えに失敗しました:",e)})})(t,e)},p))},F=()=>P({preserveState:!0}),k=()=>P({preserveState:!0}),L=()=>{x&&!v&&(v=!0,y&&("function"==typeof y.addEventListener?y.addEventListener("change",F):"function"==typeof y.addListener&&y.addListener(F)),window.addEventListener("resize",k))};return x&&(b=_(I(),{preserveState:!1}),f&&L()),{getPlayer:()=>u,getVariant:()=>g,setResponsiveSwitching(e){const t=Boolean(e);t!==f&&(f=t,f?(L(),P({preserveState:!0})):x&&v&&(v=!1,window.clearTimeout(w),y&&("function"==typeof y.removeEventListener?y.removeEventListener("change",F):"function"==typeof y.removeListener&&y.removeListener(F)),window.removeEventListener("resize",k)))}}}({variants:{desktop:{imageNames:n,publicPath:"./imgs/desktop/"},mobile:{imageNames:n,publicPath:"./imgs/mobile/"}},playerOptions:{mountId:"player",extension:"jpeg",interval:80,loop:!0,autoPlay:!1,responsiveSwitching:!1},breakpointQuery:"(max-width: 900px)",breakpointWidth:900,debounceMs:150});function a(e,t){const i=document.getElementById(e);i instanceof HTMLButtonElement?t(i):console.warn(`${e} ボタンが見つかりませんでした。`)}a("preload-button",e=>{e.addEventListener("click",async()=>{const t=s.getPlayer();if(!t)return void console.warn("プレイヤーが初期化されていません。");e.disabled=!0;const i=e.textContent??"プリロード";e.textContent="プリロード中...";try{await t.preload(),e.textContent="プリロード完了"}catch(n){console.error("プリロードに失敗しました:",n),e.textContent="プリロード失敗"}finally{setTimeout(()=>{e.textContent=i,e.disabled=!1},600)}})}),a("play-button",e=>{e.addEventListener("click",async()=>{const t=s.getPlayer();if(!t)return void console.warn("プレイヤーが初期化されていません。");e.disabled=!0;const i=e.textContent??"再生";e.textContent="再生準備中...";try{await t.play(),e.textContent="再生中"}catch(n){console.error("再生に失敗しました:",n),e.textContent="再生失敗"}finally{setTimeout(()=>{e.textContent=i,e.disabled=!1},400)}})}),a("pause-button",e=>{e.addEventListener("click",()=>{const e=s.getPlayer();e?e.pause():console.warn("プレイヤーが初期化されていません。")})}),a("stop-button",e=>{e.addEventListener("click",()=>{const e=s.getPlayer();e?e.stop():console.warn("プレイヤーが初期化されていません。")})})}}});
